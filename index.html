<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark">
    <title>Dark Glass App</title>
    
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header>
        <div class="btn-wrapper" id="header-btn-wrap">
            <button class="login-trigger" id="ui-target">Login</button>
        </div>
    </header>

    <div id="login-modal">
        <div class="auth-card">
            <span class="close-btn" id="close-modal">Ã—</span>
            <div id="auth-content">
                <h2 id="auth-title">Welcome</h2>
                <input type="email" placeholder="Email Address" id="email">
                <input type="password" placeholder="Password" id="password">
                <button class="submit-btn" id="main-btn">Enter Dimension</button>
                <p class="toggle-link" id="switch-btn">New explorer? <span>Register here</span></p>
            </div>
        </div>
    </div>

    <div id="app">
        <div style="padding-top: 150px; text-align: center;">
            <h1>Dimension Locked</h1>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        // Import Realtime Database
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
            authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
            projectId: "itzhoyoo-f9f7e",
            storageBucket: "itzhoyoo-f9f7e.filestorage.app",
            messagingSenderId: "1094792075584",
            appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
            databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com" // Ensure this matches your RTDB URL
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        const modal = document.getElementById('login-modal');
        const mainBtn = document.getElementById('main-btn');
        const uiTarget = document.getElementById('ui-target');
        const headerBtnWrap = document.getElementById('header-btn-wrap');
        
        let isLogin = true;

        const toggleModal = () => modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
        document.getElementById('close-modal').onclick = toggleModal;

        document.getElementById('switch-btn').onclick = () => {
            isLogin = !isLogin;
            document.getElementById('auth-title').innerText = isLogin ? "Welcome" : "Join Us";
            mainBtn.innerText = isLogin ? "Enter Dimension" : "Create Identity";
        };

        mainBtn.onclick = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                if (isLogin) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const res = await createUserWithEmailAndPassword(auth, email, password);
                    const username = email.split('@')[0];
                    // Save to Firestore
                    await setDoc(doc(db, "explorers", res.user.uid), { username });
                    // Initialize AITOKENS in Realtime Database
                    await set(ref(rtdb, 'AITOKENS/' + res.user.uid), {
                        tokens: 100, // Starting bonus
                        username: username
                    });
                }
                toggleModal();
            } catch (e) { alert(e.message); }
        };

        // --- REAL-TIME PROFILE UPDATER ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const usernameBase = user.email.split('@')[0];
                const pic = `https://ui-avatars.com/api/?name=${usernameBase}&background=00ffff&color=000000`;

                // Listen to Tokens in Realtime Database
                const tokenRef = ref(rtdb, 'AITOKENS/' + user.uid);
                onValue(tokenRef, (snapshot) => {
                    const data = snapshot.val();
                    const tokenCount = data ? data.tokens : 0;
                    const displayUsername = data ? data.username : usernameBase;

                    // Update the header button with the new layout
                    uiTarget.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 12px; text-align: left;">
                            <img src="${pic}" style="width: 32px; height: 32px; border-radius: 50%; border: 1.5px solid #00ffff;">
                            <div style="display: flex; flex-direction: column; line-height: 1.2;">
                                <span style="font-size: 0.85rem; font-weight: 700; color: #fff;">@${displayUsername}</span>
                                <span style="font-size: 0.7rem; color: #00ffff; font-family: monospace;">${tokenCount} TOKENS</span>
                            </div>
                        </div>
                    `;
                });

                headerBtnWrap.onclick = () => { if(confirm("Logout?")) signOut(auth); };
                document.getElementById('app').innerHTML = `<h1>Connected to Grid</h1>`;
            } else {
                uiTarget.innerHTML = "Login";
                headerBtnWrap.onclick = toggleModal;
                document.getElementById('app').innerHTML = `<h1>Dimension Locked</h1>`;
            }
        });
    </script>
</body>
</html>
