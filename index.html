<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark">
    <title>Dark Glass App</title>
    
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <header>
        <div class="btn-wrapper" id="header-btn-wrap">
            <button class="login-trigger" id="ui-target">Login</button>
        </div>
    </header>

    <div id="login-modal">
        <div class="auth-card">
            <span class="close-btn" id="close-modal">Ã—</span>
            <div id="auth-content">
                <h2 id="auth-title">Welcome</h2>
                <input type="email" placeholder="Email Address" id="email">
                <input type="password" placeholder="Password" id="password">
                <button class="submit-btn" id="main-btn">Enter Dimension</button>
                <p class="toggle-link" id="switch-btn">New explorer? <span>Register here</span></p>
            </div>
        </div>
    </div>

    <div id="app">
        <div style="padding-top: 150px; text-align: center;">
            <h1>Dimension Locked</h1>
            <p>Authentication required to access the grid.</p>
        </div>
    </div>

    <script type="module">
        // 1. Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
            authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
            projectId: "itzhoyoo-f9f7e",
            storageBucket: "itzhoyoo-f9f7e.filestorage.app",
            messagingSenderId: "1094792075584",
            appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 3. UI Selectors
        const modal = document.getElementById('login-modal');
        const mainBtn = document.getElementById('main-btn');
        const uiTarget = document.getElementById('ui-target');
        const headerBtnWrap = document.getElementById('header-btn-wrap');
        const authTitle = document.getElementById('auth-title');
        const switchBtn = document.getElementById('switch-btn');
        
        let isLogin = true;

        // 4. Modal & Toggle Logic
        const toggleModal = () => {
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
        };

        document.getElementById('close-modal').onclick = toggleModal;

        switchBtn.onclick = () => {
            isLogin = !isLogin;
            authTitle.innerText = isLogin ? "Welcome" : "Join Us";
            mainBtn.innerText = isLogin ? "Enter Dimension" : "Create Identity";
            switchBtn.innerHTML = isLogin ? 
                "New explorer? <span>Register here</span>" : 
                "Already a member? <span>Login here</span>";
        };

        // 5. Authentication Execution
        mainBtn.onclick = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if(!email || !password) return alert("Fill all fields.");

            try {
                if (isLogin) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const res = await createUserWithEmailAndPassword(auth, email, password);
                    const username = email.split('@')[0];
                    // Save the user identity to Firestore
                    await setDoc(doc(db, "explorers", res.user.uid), {
                        username: username,
                        photoURL: `https://ui-avatars.com/api/?name=${username}&background=00ffff&color=000000`,
                        joined: new Date().toISOString()
                    });
                }
                toggleModal();
            } catch (e) {
                alert(e.message);
            }
        };

        // 6. THE FIX: Auth State Observer
        // This watches for login/logout and updates the header button
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in - Fetch profile
                let name = user.email.split('@')[0];
                let pic = `https://ui-avatars.com/api/?name=${name}&background=00ffff&color=000000`;

                try {
                    const docSnap = await getDoc(doc(db, "explorers", user.uid));
                    if (docSnap.exists()) {
                        name = docSnap.data().username;
                        pic = docSnap.data().photoURL;
                    }
                } catch (err) {
                    console.log("Firestore fetch failed, using fallbacks.");
                }

                // Inject Profile UI into the racing button
                uiTarget.innerHTML = `
                    <div class="profile-container">
                        <img src="${pic}" class="profile-pic" alt="avatar">
                        <span class="username-display">@${name}</span>
                    </div>
                `;

                // Update Header Click to Sign Out
                headerBtnWrap.onclick = () => {
                    if(confirm("Disconnect from Dimension?")) signOut(auth);
                };

                // Update Main Page
                document.getElementById('app').innerHTML = `
                    <div style="padding-top: 150px; text-align: center;">
                        <h1>Access Granted</h1>
                        <p>Welcome, @${name}. The grid is yours.</p>
                    </div>
                `;
            } else {
                // User is signed out - Reset to Login Button
                uiTarget.innerHTML = "Login";
                headerBtnWrap.onclick = toggleModal;
                document.getElementById('app').innerHTML = `
                    <div style="padding-top: 150px; text-align: center;">
                        <h1>Dimension Locked</h1>
                        <p>Authentication required to access the grid.</p>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
