<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark">
    <title>Dark Glass App</title>
    
    <link rel="stylesheet" href="style.css">

    <style>
        /* ADD ONLY THESE NEW CLASSES TO YOUR style.css */
        .profile-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
            text-align: left;
            width: 100%;
        }

        .profile-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1.5px solid var(--cyan);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
            object-fit: cover;
        }

        .profile-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
            line-height: 1.1;
        }

        .prof-user {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text);
            letter-spacing: 0.3px;
        }

        .prof-tokens {
            font-size: 0.65rem;
            color: var(--cyan);
            font-family: 'Courier New', Courier, monospace;
            text-transform: uppercase;
            margin-top: 2px;
        }
    </style>
</head>
<body>

    <header>
        <div class="btn-wrapper" id="header-btn-wrap">
            <button class="login-trigger" id="ui-target">Login</button>
        </div>
    </header>

    <div id="login-modal">
        <div class="auth-card">
            <span class="close-btn" id="close-modal">Ã—</span>
            <h2 id="auth-title">Welcome</h2>
            <input type="email" placeholder="Email" id="email">
            <input type="password" placeholder="Password" id="password">
            <button class="submit-btn" id="main-btn">Enter Dimension</button>
            <p class="toggle-link" id="switch-btn">New explorer? <span>Register here</span></p>
        </div>
    </div>

    <div id="app"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
            authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
            projectId: "itzhoyoo-f9f7e",
            storageBucket: "itzhoyoo-f9f7e.filestorage.app",
            messagingSenderId: "1094792075584",
            appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
            databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        const modal = document.getElementById('login-modal');
        const uiTarget = document.getElementById('ui-target');
        const headerBtnWrap = document.getElementById('header-btn-wrap');
        let isLogin = true;

        const toggleModal = () => modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
        document.getElementById('close-modal').onclick = toggleModal;

        document.getElementById('switch-btn').onclick = () => {
            isLogin = !isLogin;
            document.getElementById('auth-title').innerText = isLogin ? "Welcome" : "Join Us";
            document.getElementById('main-btn').innerText = isLogin ? "Enter Dimension" : "Create Identity";
        };

        document.getElementById('main-btn').onclick = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                if (isLogin) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const res = await createUserWithEmailAndPassword(auth, email, password);
                    const username = email.split('@')[0];
                    await setDoc(doc(db, "explorers", res.user.uid), { username });
                    await set(ref(rtdb, 'AITOKENS/' + res.user.uid), {
                        tokens: 100,
                        username: username
                    });
                }
                toggleModal();
            } catch (e) { alert(e.message); }
        };

        // --- AUTH OBSERVER ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const usernameBase = user.email.split('@')[0];
                const pic = `https://ui-avatars.com/api/?name=${usernameBase}&background=00ffff&color=000000`;

                // Live Token Listener
                const tokenRef = ref(rtdb, 'AITOKENS/' + user.uid);
                onValue(tokenRef, (snapshot) => {
                    const data = snapshot.val();
                    const tokens = data ? data.tokens : 0;
                    const name = data ? data.username : usernameBase;

                    uiTarget.innerHTML = `
                        <div class="profile-wrapper">
                            <img src="${pic}" class="profile-avatar">
                            <div class="profile-info">
                                <span class="prof-user">@${name}</span>
                                <span class="prof-tokens">${tokens} TOKENS</span>
                            </div>
                        </div>
                    `;
                });

                headerBtnWrap.onclick = () => { if(confirm("Sign out?")) signOut(auth); };
            } else {
                uiTarget.innerHTML = "Login";
                headerBtnWrap.onclick = toggleModal;
            }
        });
    </script>
</body>
</html>
