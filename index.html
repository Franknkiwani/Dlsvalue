<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark">
    <title>Dark Glass App</title>
    
    <link rel="stylesheet" href="style.css">

    <style>
        /* Profile Layout inside the racing button */
        .profile-container {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 10px;
            width: 100%;
            height: 100%;
        }

        .profile-pic {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid var(--cyan);
            object-fit: cover;
        }

        .username-display {
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text);
        }
    </style>
</head>
<body>

    <header>
        <div class="btn-wrapper" id="header-btn-container">
            <button class="login-trigger" id="auth-ui-target">Login</button>
        </div>
    </header>

    <div id="login-modal">
        <div class="auth-card">
            <span class="close-btn" id="close-modal-btn">Ã—</span>
            <div id="auth-content">
                <h2 id="auth-title">Welcome</h2>
                <input type="email" placeholder="Email Address" id="email">
                <input type="password" placeholder="Password" id="password">
                <button class="submit-btn" id="main-btn">Enter Dimension</button>
                <p class="toggle-link" id="auth-toggle">New explorer? <span>Register here</span></p>
            </div>
        </div>
    </div>

    <div id="app"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            onAuthStateChanged,
            signOut 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
            authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
            projectId: "itzhoyoo-f9f7e",
            storageBucket: "itzhoyoo-f9f7e.filestorage.app",
            messagingSenderId: "1094792075584",
            appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const modal = document.getElementById('login-modal');
        const authTitle = document.getElementById('auth-title');
        const mainBtn = document.getElementById('main-btn');
        const authToggle = document.getElementById('auth-toggle');
        const uiTarget = document.getElementById('auth-ui-target');
        const closeBtn = document.getElementById('close-modal-btn');
        const headerBtnWrap = document.getElementById('header-btn-container');

        let isLogin = true;

        const toggleModal = () => {
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
        };

        const switchAuth = () => {
            isLogin = !isLogin;
            if(isLogin) {
                authTitle.innerText = "Welcome";
                mainBtn.innerText = "Enter Dimension";
                authToggle.innerHTML = "New explorer? <span>Register here</span>";
            } else {
                authTitle.innerText = "Join Us";
                mainBtn.innerText = "Create Identity";
                authToggle.innerHTML = "Already a member? <span>Login here</span>";
            }
        };

        // Handle Logout or Open Modal
        headerBtnWrap.addEventListener('click', () => {
            if (auth.currentUser) {
                if(confirm("Exit the dimension?")) signOut(auth);
            } else {
                toggleModal();
            }
        });

        closeBtn.addEventListener('click', toggleModal);
        authToggle.addEventListener('click', switchAuth);

        mainBtn.addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            if (!email || !password) return alert("Credentials required.");

            try {
                if (isLogin) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    // Extract username from email for default display
                    const username = email.split('@')[0];
                    await setDoc(doc(db, "explorers", userCredential.user.uid), {
                        username: username,
                        email: email,
                        photoURL: `https://ui-avatars.com/api/?name=${username}&background=00ffff&color=000000`,
                        created: new Date().toISOString()
                    });
                }
                toggleModal();
            } catch (error) {
                alert(error.message);
            }
        });

        // --- DYNAMIC UI UPDATER ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Fetch username from Firestore
                const docRef = doc(db, "explorers", user.uid);
                const docSnap = await getDoc(docRef);
                let username = user.email.split('@')[0];
                let photo = `https://ui-avatars.com/api/?name=${username}&background=00ffff&color=000000`;

                if (docSnap.exists()) {
                    username = docSnap.data().username;
                    photo = docSnap.data().photoURL || photo;
                }

                // Inject Profile UI into the racing button
                uiTarget.innerHTML = `
                    <div class="profile-container">
                        <img src="${photo}" class="profile-pic" alt="avatar">
                        <span class="username-display">@${username}</span>
                    </div>
                `;
                document.getElementById('app').innerHTML = `<h1>Access Granted: ${username}</h1>`;
            } else {
                // Reset to Login button
                uiTarget.innerHTML = `Login`;
                document.getElementById('app').innerHTML = `<h1>Dimension Locked.</h1>`;
            }
        });
    </script>
</body>
</html>
